/*!
 * Raster Map Projection v0.0.9  2016-09-04
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";if("undefined"!=typeof module&&module.exports)var ProjMath=require("./rasterproj-common.js");var TileManager=function(a){this.rootNumX=2,this.rootNumY=1,this.rootTileSizeX=Math.PI,this.rootTileSizeY=Math.PI,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],"undefined"!=typeof a&&("rootNumX"in a&&(this.rootNumX=a.rootNumX),"rootNumY"in a&&(this.rootNumY=a.rootNumY),"rootTileSizeX"in a&&(this.rootTileSizeX=a.rootTileSizeX),"tileSizeY"in a&&(this.rootTileSizeY=a.rootTileSizeY),"numLevels"in a&&(this.numLevels=a.numLevels),"inverseY"in a&&(this.inverseY=a.inverseY),"tileOrigin"in a&&(this.tileOrigin=a.tileOrigin)),this.rootSizeX=this.rootNumX*this.rootTileSizeX,this.rootSizeY=this.rootNumY*this.rootTileSizeY};TileManager.prototype.getTileX_=function(a,b){return Math.floor(a*(b-this.tileOrigin[0])/this.rootSizeX)},TileManager.prototype.getTileY_=function(a,b){var c=this.inverseY?-1:1;return Math.floor(c*a*(b-this.tileOrigin[1])/this.rootSizeY)},TileManager.prototype.getTileNum_=function(a){var b=Math.round(ProjMath.clamp(a,0,this.numLevels-1)),c=1<<b;return[c*this.rootNumX,c*this.rootNumY]},TileManager.prototype.getTileInfos=function(a,b,c,d){var e,f,g=this.getTileNum_(c),h=g[0],i=g[1],j=this.getTileX_(h,a[0]),k=this.getTileX_(h,a[1]);this.inverseY?(e=this.getTileY_(i,b[1]),f=this.getTileY_(i,b[0])):(e=this.getTileY_(i,b[0]),f=this.getTileY_(i,b[1]));for(var l=[],m=i+1,n=e;n<=f;++n){var o=n%i;if(m==o)break;o<m&&(m=o);for(var p=h+1,q=j;q<=k;++q){var r=q%h;if(p==r)break;r<p&&(p=r);var s,t,u=d(c,r,o),v=this.rootSizeX*r/h+this.tileOrigin[0],w=this.rootSizeX*(r+1)/h+this.tileOrigin[0];this.inverseY?(s=-this.rootSizeY*(o+1)/i+this.tileOrigin[1],t=-this.rootSizeY*o/i+this.tileOrigin[1]):(s=this.rootSizeY*o/i+this.tileOrigin[1],t=this.rootSizeY*(o+1)/i+this.tileOrigin[1]),l.push({url:u,rect:[v,s,w,t]})}}return l};var ImageCache=function(a){this.num=32,this.crossOrigin=null,this.textures={},this.loading={},this.ongoingImageLoads=[],"undefined"!=typeof a&&("num"in a&&(this.num=a.num),"crossOrigin"in a&&(this.crossOrigin=a.crossOrigin)),this.createTexture=null};ImageCache.prototype.loadImage_=function(a,b){this.loading[a]=!0;var c=new Image;null!=this.crossOrigin&&(c.crossOrigin=this.crossOrigin);var d=this;c.onload=function(){if(d.ongoingImageLoads.splice(d.ongoingImageLoads.indexOf(c),1),null!=d.createTexture){var e=d.createTexture(c);e&&(d.textures[a]=[e,b]),delete d.loading.url}},this.ongoingImageLoads.push(c),c.src=a},ImageCache.prototype.loadImageIfAbsent=function(a,b){return!(a in this.textures)&&(!(a in this.loading)&&(this.loadImage_(a,b),!0))},ImageCache.prototype.getTexture=function(a){var b=this.textures[a];return b},ImageCache.prototype.clearOngoingImageLoads=function(){for(var a=0;a<this.ongoingImageLoads.length;a++)this.ongoingImageLoads[a].onload=void 0;this.ongoingImageLoads=[]};var MapView=function(a,b,c,d){this.gl=a,this.imageProj=b,this.tileManager=new TileManager(c),this.prevTileInfos_=null,this.prevWindow_=null,this.imageCache=new ImageCache(d);var e=this;this.imageCache.createTexture=function(a){return e.createTexture_(a)},this.graticuleInterval=20,this.createUrl=null,this.calculateLevel=null};MapView.prototype.clearTileInfoCache_=function(){this.prevWindow_=null,this.prevTileInfos_=null},MapView.prototype.setProjCenter=function(a,b){this.clearTileInfoCache_(),this.imageProj.setProjCenter(a,b)},MapView.prototype.getProjCenter=function(){return this.imageProj.projection.getProjCenter()},MapView.prototype.setWindow=function(a,b,c,d){this.clearTileInfoCache_(),this.imageProj.setViewWindow(a,b,c,d)},MapView.prototype.moveWindow=function(a,b){this.imageProj.moveWindow(a,b)},MapView.prototype.zoomWindow=function(a){this.imageProj.zoomWindow(a)},MapView.prototype.getViewCenterPoint=function(){return this.imageProj.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(a,b){this.imageProj.setViewWindowCenter(a,b)},MapView.prototype.getLambdaPhiPointFromWindow=function(a,b){var c=this.imageProj.getViewPointFromWindow(a,b);return this.imageProj.projection.inverse(c[0],c[1])},MapView.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads()},MapView.prototype.requestImagesIfNecessary=function(){if(null==this.createUrl)return-1;var a=this.getTileInfos_(),b=this.requestImages_(a);return b},MapView.prototype.render=function(){if(null!=this.createUrl){var a=this.getTileInfos_();this.requestImages_(a),this.render_(a)}},MapView.prototype.createTexture_=function(a){var b=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,b),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,b),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a),this.gl.bindTexture(this.gl.TEXTURE_2D,null),b},MapView.prototype.getTileInfos_=function(){var a=this.imageProj.getViewWindow();if(null!=this.prevTileInfos_&&null!=this.prevWindow_){if(a[0]==this.prevWindow_[0]&&a[1]==this.prevWindow_[1]&&a[2]==this.prevWindow_[2]&&a[3]==this.prevWindow_[3])return this.prevTileInfos_;this.prevTileInfos_=null,this.prevWindow_=null}var b=this.imageProj.projection.inverseBoundingBox(a[0],a[1],a[2],a[3]),c=null!=this.calculateLevel?this.calculateLevel(a,b):0,d=this.tileManager.getTileInfos(b.lambda,b.phi,c,this.createUrl);return this.prevWindow_=a,this.prevTileInfos_=d,d},MapView.prototype.requestImages_=function(a){for(var b=0,c=0;c<a.length;++c)this.imageCache.loadImageIfAbsent(a[c].url,a[c].rect)&&++b;return b},MapView.prototype.render_=function(a){this.imageProj.clear();for(var b=[],c=0;c<a.length;++c){var d=a[c],e=this.imageCache.getTexture(d.url);e&&b.push(e)}0<b.length&&this.imageProj.renderTextures(b),0<this.graticuleInterval&&this.imageProj.renderGraticule(this.graticuleInterval)},"undefined"!=typeof module&&module.exports&&(module.exports=MapView,module.exports.TileManager=TileManager);