/*!
 * Raster Map Projection v0.0.2  2016-07-06
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";var TileManager=function(a){this.rootNumX=2,this.rootNumY=1,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],"undefined"!=typeof a&&("rootNumX"in a&&(this.rootNumX=a.rootNumX),"rootNumY"in a&&(this.rootNumY=a.rootNumY),"numLevels"in a&&(this.numLevels=a.numLevels),"inverseY"in a&&(this.inverseY=a.inverseY),"tileOrigin"in a&&(this.tileOrigin=a.tileOrigin))};TileManager.prototype.getTileX_=function(a,b){return Math.floor(a*(b-this.tileOrigin[0])/(2*Math.PI))},TileManager.prototype.getTileY_=function(a,b){return Math.floor(a*(b-this.tileOrigin[1])/Math.PI)},TileManager.prototype.getTileNum_=function(a){var b=Math.round(ProjMath.clamp(a,0,this.numLevels-1)),c=1<<b;return[c*this.rootNumX,c*this.rootNumY]},TileManager.prototype.getTileInfos=function(a,b,c,d){for(var e=this.getTileNum_(c),f=e[0],g=e[1],h=this.getTileX_(f,a[0]),i=this.getTileX_(f,a[1]),j=this.getTileY_(g,b[0]),k=this.getTileY_(g,b[1]),l=[],m=g+1,n=j;k>=n;++n){var o=n%g;if(m==o)break;m>o&&(m=o);for(var p=f+1,q=h;i>=q;++q){var r=q%f;if(p==r)break;p>r&&(p=r);var s=d(c,r,o),t=2*Math.PI*r/f-Math.PI,u=2*Math.PI*(r+1)/f-Math.PI,v=Math.PI*o/g-Math.PI/2,w=Math.PI*(o+1)/g-Math.PI/2;l.push({url:s,rect:[t,v,u,w]})}}return l};var ImageCache=function(a){this.num=a,this.textures={},this.loading={},this.ongoingImageLoads=[],this.createTexture=null};ImageCache.prototype.loadImage_=function(a,b){this.loading[a]=!0;var c=new Image,d=this;c.onload=function(){if(d.ongoingImageLoads.splice(d.ongoingImageLoads.indexOf(c),1),null!=d.createTexture){var e=d.createTexture(c);e&&(d.textures[a]=[e,b]),delete d.loading.url}},this.ongoingImageLoads.push(c),c.src=a},ImageCache.prototype.loadImageIfAbsent=function(a,b){return a in this.textures?!1:a in this.loading?!1:(this.loadImage_(a,b),!0)},ImageCache.prototype.getTexture=function(a){var b=this.textures[a];return b},ImageCache.prototype.clearOngoingImageLoads=function(){for(var a=0;a<this.ongoingImageLoads.length;a++)this.ongoingImageLoads[a].onload=void 0;this.ongoingImageLoads=[]};var MapView=function(a,b,c,d,e){this.gl=a;var f=new RasterProjAEQD(a,b.width,b.height);f.initShader(),f.setProjCenter(c,d),this.imageProj=f,this.proj=new ProjAEQD(c,d),this.tileManager=new TileManager(e),this.imageCache=new ImageCache(50);var g=this;this.imageCache.createTexture=function(a){return g.createTexture_(a)},this.createUrl=null,this.calculateLevel=null};MapView.prototype.setProjCenter=function(a,b){this.imageProj.setProjCenter(a,b),this.proj=new ProjAEQD(a,b)},MapView.prototype.getProjCenter=function(){return this.proj.getProjCenter()},MapView.prototype.setWindow=function(a,b,c,d){this.imageProj.setViewWindow(a,b,c,d)},MapView.prototype.moveWindow=function(a,b){this.imageProj.moveWindow(a,b)},MapView.prototype.zoomWindow=function(a){this.imageProj.zoomWindow(a)},MapView.prototype.getViewCenterPoint=function(){return this.imageProj.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(a,b){this.imageProj.setViewWindowCenter(a,b)},MapView.prototype.getLambdaPhiPointFromWindow=function(a,b){var c=this.imageProj.getViewPointFromWindow(a,b);return this.proj.inverse(c[0],c[1])},MapView.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads()},MapView.prototype.requestImagesIfNecessary=function(){if(null==this.createUrl)return-1;var a=this.getTileInfos_(),b=this.requestImages_(a);return b},MapView.prototype.render=function(){if(null!=this.createUrl){var a=this.getTileInfos_();this.requestImages_(a),this.render_(a)}},MapView.prototype.createTexture_=function(a){var b=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,b),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,b),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a),this.gl.bindTexture(this.gl.TEXTURE_2D,null),b},MapView.prototype.getTileInfos_=function(){var a=this.imageProj.getViewWindow(),b=this.proj.inverseBoundingBox(a[0],a[1],a[2],a[3]),c=null!=this.calculateLevel?this.calculateLevel(a,b):0,d=this.tileManager.getTileInfos(b.lambda,b.phi,c,this.createUrl);return d},MapView.prototype.requestImages_=function(a){for(var b=0,c=0;c<a.length;++c)this.imageCache.loadImageIfAbsent(a[c].url,a[c].rect)&&++b;return b},MapView.prototype.render_=function(a){this.imageProj.clear();for(var b=[],c=0;c<a.length;++c){var d=a[c],e=this.imageCache.getTexture(d.url);e&&b.push(e)}0<b.length&&this.imageProj.renderTextures(b)};