/*!
 * Raster Map Projection v0.0.7  2016-08-09
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";var CoordTransform=function(a,b){this.src_x1_=a[0],this.src_y1_=a[1],this.src_x2_=a[2],this.src_y2_=a[3],this.src_width_=a[2]-a[0],this.src_height_=a[3]-a[1],this.dst_x1_=b[0],this.dst_y1_=b[1],this.dst_x2_=b[2],this.dst_y2_=b[3],this.dst_width_=b[2]-b[0],this.dst_height_=b[3]-b[1]};CoordTransform.prototype.forwardPoint=function(a){var b=this.dst_x1_+(a[0]-this.src_x1_)*this.dst_width_/this.src_width_,c=this.dst_y1_+(a[1]-this.src_y1_)*this.dst_height_/this.src_height_;return[b,c]},CoordTransform.prototype.forwardRect=function(a){var b=this.forwardPoint([a[0],a[1]]),c=this.forwardPoint([a[2],a[3]]);return[b[0],b[1],c[0],c[1]]};var ProjMath=function(){};ProjMath.EPSILON=1e-7,ProjMath.SQRT_2=Math.sqrt(2),ProjMath.PI_SQ=Math.PI*Math.PI,ProjMath.HALF_PI=Math.PI/2,ProjMath.clamp=function(a,b,c){return Math.max(b,Math.min(c,a))},ProjMath.atan2Range=function(a,b){var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=b[0]<=b[1]?b[0]:b[1],f=b[0]<=b[1]?b[1]:b[0];if(0<=e)return 0<c?[Math.atan2(e,d),Math.atan2(f,c)]:d<0?[Math.atan2(f,d),Math.atan2(e,c)]:[Math.atan2(e,d),Math.atan2(e,c)];if(f<0)return 0<c?[Math.atan2(e,c),Math.atan2(f,d)]:d<0?[Math.atan2(f,c),Math.atan2(e,d)]:[Math.atan2(f,c),Math.atan2(f,d)];if(0<c)return[Math.atan2(e,c),Math.atan2(f,c)];if(d<0){var g=Math.atan2(f,d),h=Math.atan2(e,d);return Math.PI<=g?[g-2*Math.PI,h]:[g,h+2*Math.PI]}return[-Math.PI,Math.PI]},ProjMath.toLambdaPhi=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]),c=Math.atan2(a[1],a[0]),d=Math.atan2(a[2],b);return{lambda:c,phi:d}},ProjMath.normalizeLambda=function(a){return-Math.PI<=a&&a<Math.PI?a:a-2*Math.PI*Math.floor((a+Math.PI)/(2*Math.PI))},ProjMath.neighborPoint=function(a,b){if(ProjMath.EPSILON<=Math.abs(a.phi-b.phi))return!1;var c=ProjMath.normalizeLambda(a.lambda),d=ProjMath.normalizeLambda(b.lambda);return Math.abs(c-d)<ProjMath.EPSILON};var GraticuleGenerator=function(a,b,c){this.projection=a,this.degUnit=c,this.maxNumPoints=b,this.graticulePointsDistLimit=.01,this.maxRecursion=5};GraticuleGenerator.prototype.transform_=function(a,b,c){var d=this.projection.forward(b,c);return d?a.forwardPoint([d.x,d.y]):null},GraticuleGenerator.prototype.isFarAway_=function(a,b){if(!a)return!1;var c=Math.abs(a[0]-b[0])+Math.abs(a[1]-b[1]);return 4*this.graticulePointsDistLimit<c},GraticuleGenerator.prototype.isInViewRect_=function(a){return-1<=a[0]&&a[0]<=1&&-1<=a[1]&&a[1]<=1},GraticuleGenerator.prototype.generateLines=function(a){for(var b=a[0],c=a[1],d=a[2],e=a[3],f=this.projection.inverseBoundingBox(b,c,d,e),g=new CoordTransform(a,[-1,-1,1,1]),h=Math.ceil((180*f.lambda[0]/Math.PI+180)/this.degUnit)*this.degUnit-180,i=Math.ceil((180*f.phi[0]/Math.PI+80)/this.degUnit)*this.degUnit-80,j=new PolylineContainer,k=h;k<=540;k+=this.degUnit){var l=k*Math.PI/180;if(f.lambda[1]<l||h+360<=l)break;this.generateLatitudeLines_(j,l,f.phi,g)}for(var m=i;m<=80;m+=this.degUnit){var n=m*Math.PI/180;if(f.phi[1]<n)break;this.generateLongitudeLines_(j,n,f.lambda,g)}return j.polylineArray},GraticuleGenerator.prototype.generateLatitudeLines_=function(a,b,c,d){var e=this.maxNumPoints-1,f=80*Math.PI/180,g=c[0]<-f?-f:c[0],h=f<c[1]?f:c[1],i=LatitudeLineInterpolator.create(this.projection,d,b,g,h,e);this.generateEachLine_(a,d,i)},GraticuleGenerator.prototype.generateLongitudeLines_=function(a,b,c,d){var e=this.maxNumPoints-1;if(Math.PI<c[1]-c[0]){var f=(c[0]+c[1])/2,g=LongitudeLineInterpolator.create(this.projection,d,b,c[0],f,e),h=LongitudeLineInterpolator.create(this.projection,d,b,f,c[1],e);this.generateEachLine_(a,d,g),this.generateEachLine_(a,d,h)}else{var i=LongitudeLineInterpolator.create(this.projection,d,b,c[0],c[1],e);this.generateEachLine_(a,d,i)}},GraticuleGenerator.prototype.generateEachLine_=function(a,b,c){if(!c)return!1;if(this.maxRecursion<c.recurseCount())return this.generateEachPoints2_(a,b,c),!0;var d=c.getNormBetweenEndPoints()/c.max();if(d<this.graticulePointsDistLimit)return this.generateEachPoints2_(a,b,c),!0;for(var e=c.divide(this.projection,b),f=0;f<e.length;++f)this.generateEachLine_(a,b,e[f]);return!0},GraticuleGenerator.prototype.generateEachPoints2_=function(a,b,c){var d=null;this.isInViewRect_(c.iniPoint)?a.add(c.iniPoint):d=c.iniPoint;for(var e=c.iniPoint,f=1;f<c.max();++f){var g=this.transform_(b,c.lambda(f),c.phi(f));g?this.isInViewRect_(g)?(this.isFarAway_(e,g)?(a.endPolyline(),a.add(g)):(d||a.add(d),a.add(g)),d=null):(this.isFarAway_(e,g)?a.endPolyline():a.endPolyline(g),d=g):(a.endPolyline(),d=null),e=g}a.endPolyline(c.finPoint)};var LongitudeLineInterpolator=function(a,b,c,d,e,f,g){this.iniPoint=e,this.finPoint=f,this.phi_=b,this.lambda1_=c,this.lambda2_=d,this.max_=g,this.length_=d-c,this.recurseCount_=0};LongitudeLineInterpolator.create=function(a,b,c,d,e,f){for(var g,h=e-d,i=null,j=null,k=0;k<f;++k){g=h*k/f+d;var l=a.forward(g,c);if(l){i=b.forwardPoint([l.x,l.y]),j=g;break}}if(!i)return null;for(var m=null,n=null,o=f;k<o;--o){g=h*o/f+d;var p=a.forward(g,c);if(p){m=b.forwardPoint([p.x,p.y]),n=g;break}}return m?new LongitudeLineInterpolator(b,c,j,n,i,m,f):null},LongitudeLineInterpolator.prototype.recurseCount=function(){return this.recurseCount_},LongitudeLineInterpolator.prototype.max=function(){return this.max_},LongitudeLineInterpolator.prototype.getNormBetweenEndPoints=function(){return Math.abs(this.finPoint[0]-this.iniPoint[0])+Math.abs(this.finPoint[1]-this.iniPoint[1])},LongitudeLineInterpolator.prototype.lambda=function(a){return this.length_*a/this.max_+this.lambda1_},LongitudeLineInterpolator.prototype.phi=function(a){return this.phi_},LongitudeLineInterpolator.prototype.divide=function(a,b){var c=[],d=(this.lambda1_+this.lambda2_)/2,e=LongitudeLineInterpolator.create(a,b,this.phi_,this.lambda1_,d,this.max_);e&&(e.recurseCount_=this.recurseCount_+1,c.push(e));var f=LongitudeLineInterpolator.create(a,b,this.phi_,d,this.lambda2_,this.max_);return f&&(f.recurseCount_=this.recurseCount_+1,c.push(f)),c};var LatitudeLineInterpolator=function(a,b,c,d,e,f,g){this.iniPoint=e,this.finPoint=f,this.lambda_=b,this.phi1_=c,this.phi2_=d,this.max_=g,this.length_=d-c,this.recurseCount_=0};LatitudeLineInterpolator.create=function(a,b,c,d,e,f){for(var g,h=e-d,i=null,j=null,k=0;k<f;++k){g=h*k/f+d;var l=a.forward(c,g);if(l){i=b.forwardPoint([l.x,l.y]),j=g;break}}if(!i)return null;for(var m=null,n=null,o=f;k<o;--o){g=h*o/f+d;var p=a.forward(c,g);if(p){m=b.forwardPoint([p.x,p.y]),n=g;break}}return m?new LatitudeLineInterpolator(b,c,j,n,i,m,f):null},LatitudeLineInterpolator.prototype.recurseCount=function(){return this.recurseCount_},LatitudeLineInterpolator.prototype.max=function(){return this.max_},LatitudeLineInterpolator.prototype.getNormBetweenEndPoints=function(){return Math.abs(this.finPoint[0]-this.iniPoint[0])+Math.abs(this.finPoint[1]-this.iniPoint[1])},LatitudeLineInterpolator.prototype.lambda=function(a){return this.lambda_},LatitudeLineInterpolator.prototype.phi=function(a){return this.length_*a/this.max_+this.phi1_},LatitudeLineInterpolator.prototype.divide=function(a,b){var c=[],d=(this.phi1_+this.phi2_)/2,e=LatitudeLineInterpolator.create(a,b,this.lambda_,this.phi1_,d,this.max_);e&&(e.recurseCount_=this.recurseCount_+1,c.push(e));var f=LatitudeLineInterpolator.create(a,b,this.lambda_,d,this.phi2_,this.max_);return f&&(f.recurseCount_=this.recurseCount_+1,c.push(f)),c};var PolylineContainer=function(){this.polylineArray=[],this.currentPoints_=null,this.currentIndex_=0};PolylineContainer.prototype.endPolyline=function(a){if(!this.currentPoints_)return!1;var b=!1;return a&&(this.currentPoints_[this.currentIndex_++]=a[0],this.currentPoints_[this.currentIndex_++]=a[1]),2<this.currentPoints_.length&&(this.polylineArray.push(this.currentPoints_),b=!0),this.currentPoints_=null,this.currentIndex_=0,!0},PolylineContainer.prototype.add=function(a){return!!a&&(this.currentPoints_||(this.currentPoints_=[],this.currentIndex_=0),this.currentPoints_[this.currentIndex_++]=a[0],this.currentPoints_[this.currentIndex_++]=a[1],!0)},"undefined"!=typeof module&&module.exports&&(module.exports=ProjMath);