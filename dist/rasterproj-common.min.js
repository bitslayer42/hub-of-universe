/*!
 * Raster Map Projection v0.0.12  2016-10-09
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";Math.cosh||(Math.cosh=function(a){return(Math.exp(a)+Math.exp(-a))/2}),Math.sinh||(Math.sinh=function(a){return(Math.exp(a)-Math.exp(-a))/2});var CommonUtils=function(){};CommonUtils.clone=function(a){var b={};for(var c in a)b[c]=a[c];return b};var ProjMath=function(){};ProjMath.EPSILON=1e-7,ProjMath.SQRT_2=Math.sqrt(2),ProjMath.PI_SQ=Math.PI*Math.PI,ProjMath.HALF_PI=Math.PI/2,ProjMath.clamp=function(a,b,c){return Math.max(b,Math.min(c,a))},ProjMath.atan2Range=function(a,b){var c=b.min,d=b.max,e=a.min,f=a.max;if(0<=e)return 0<c?{min:Math.atan2(e,d),max:Math.atan2(f,c)}:d<0?{min:Math.atan2(f,d),max:Math.atan2(e,c)}:{min:Math.atan2(e,d),max:Math.atan2(e,c)};if(f<0)return 0<c?{min:Math.atan2(e,c),max:Math.atan2(f,d)}:d<0?{min:Math.atan2(f,c),max:Math.atan2(e,d)}:{min:Math.atan2(f,c),max:Math.atan2(f,d)};if(0<c)return{min:Math.atan2(e,c),max:Math.atan2(f,c)};if(d<0){var g=Math.atan2(f,d),h=Math.atan2(e,d);return Math.PI<=g?{min:g-2*Math.PI,max:h}:{min:g,max:h+2*Math.PI}}return{min:-Math.PI,max:Math.PI}},ProjMath.toLambdaPhi=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]),c=Math.atan2(a[1],a[0]),d=Math.atan2(a[2],b);return{lambda:c,phi:d}},ProjMath.normalizeLambda=function(a){return-Math.PI<=a&&a<Math.PI?a:a-2*Math.PI*Math.floor((a+Math.PI)/(2*Math.PI))},ProjMath.neighborPoint=function(a,b){if(ProjMath.EPSILON<=Math.abs(a.phi-b.phi))return!1;var c=ProjMath.normalizeLambda(a.lambda),d=ProjMath.normalizeLambda(b.lambda);return Math.abs(c-d)<ProjMath.EPSILON};var RasterProjShaderProgram=function(a){this.gl_=a,this.vbo_=null,this.program_=null,this.locTexture_=null,this.locAlpha_=null,this.locProjCenter_=null,this.locViewXY1_=null,this.locViewXY2_=null,this.locDataLambdaPhi1_=null,this.locDataLambdaPhi2_=null,this.locDrawGraticule_=null,this.locTranslateY_=null};RasterProjShaderProgram.DIMENSION=2,RasterProjShaderProgram.UNIT_RECT_TRIANGLE_STRIP=new Float32Array([-1,-1,-1,1,1,-1,1,1]),RasterProjShaderProgram.prototype.init=function(a,b){var c=this.loadShader_(this.gl_.VERTEX_SHADER,a),d=this.loadShader_(this.gl_.FRAGMENT_SHADER,b),e=this.gl_.createProgram();this.gl_.attachShader(e,c),this.gl_.attachShader(e,d),this.gl_.bindAttribLocation(e,0,"aPosition"),this.gl_.bindAttribLocation(e,1,"aTexCoord"),this.gl_.linkProgram(e);var f=this.gl_.getProgramParameter(e,this.gl_.LINK_STATUS);if(!f&&!this.gl_.isContextLost()){var g=this.gl_.getProgramInfoLog(e);return alert("Error linking program:\n"+g),this.gl_.deleteProgram(e),!1}return this.program_=e,this.locTexture_=this.gl_.getUniformLocation(this.program_,"uTexture"),this.locAlpha_=this.gl_.getUniformLocation(this.program_,"uAlpha"),this.locProjCenter_=this.gl_.getUniformLocation(this.program_,"uProjCenter"),this.locViewXY1_=this.gl_.getUniformLocation(this.program_,"uViewXY1"),this.locViewXY2_=this.gl_.getUniformLocation(this.program_,"uViewXY2"),this.locDataLambdaPhi1_=this.gl_.getUniformLocation(this.program_,"uDataLambdaPhi1"),this.locDataLambdaPhi2_=this.gl_.getUniformLocation(this.program_,"uDataLambdaPhi2"),this.locDrawGraticule_=this.gl_.getUniformLocation(this.program_,"uDrawGraticule"),!0},RasterProjShaderProgram.prototype.initAdditionalParams=function(){this.locTranslateY_=this.gl_.getUniformLocation(this.program_,"uTranslateY")},RasterProjShaderProgram.prototype.loadShader_=function(a,b){var c=this.gl_.createShader(a);if(this.gl_.shaderSource(c,b),this.gl_.compileShader(c),!this.gl_.getShaderParameter(c,this.gl_.COMPILE_STATUS)&&!this.gl_.isContextLost()){var d=this.gl_.getShaderInfoLog(c);return alert("Error compiling shader:\n"+d),this.gl_.deleteShader(c),null}return c},RasterProjShaderProgram.prototype.setClearColor=function(a){this.gl_.clearColor(a.r,a.g,a.b,1),this.gl_.enable(this.gl_.BLEND)},RasterProjShaderProgram.prototype.clear=function(a){this.gl_.clear(this.gl_.COLOR_BUFFER_BIT),this.gl_.viewport(0,0,a.width,a.height)},RasterProjShaderProgram.prototype.initVBO=function(a){this.vbo_=this.gl_.createBuffer(),this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,this.vbo_),this.gl_.bufferData(this.gl_.ARRAY_BUFFER,4*a*2,this.gl_.DYNAMIC_DRAW)},RasterProjShaderProgram.prototype.prepareRenderCommon=function(a,b,c,d){this.gl_.useProgram(this.program_),this.gl_.uniform1f(this.locAlpha_,d),this.gl_.uniform2f(this.locProjCenter_,b,c),this.gl_.uniform2f(this.locViewXY1_,a[0],a[1]),this.gl_.uniform2f(this.locViewXY2_,a[2],a[3]),this.gl_.uniform1i(this.locTexture_,0)},RasterProjShaderProgram.prototype.prepareRenderTexture=function(a){null!=this.locTranslateY_&&this.gl_.uniform1f(this.locTranslateY_,0),this.gl_.uniform1i(this.locDrawGraticule_,!1);var b=RasterProjShaderProgram.UNIT_RECT_TRIANGLE_STRIP.byteLength;this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,RasterProjShaderProgram.UNIT_RECT_TRIANGLE_STRIP),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,b,a);var c=2;this.gl_.enableVertexAttribArray(0),this.gl_.vertexAttribPointer(0,c,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.gl_.enableVertexAttribArray(1),this.gl_.vertexAttribPointer(1,c,this.gl_.FLOAT,this.gl_.FALSE,0,b),this.gl_.blendFunc(this.gl_.SRC_ALPHA,this.gl_.ONE)},RasterProjShaderProgram.prototype.prepareRenderPolyline=function(){this.gl_.uniform1i(this.locDrawGraticule_,!0);var a=2;this.gl_.enableVertexAttribArray(0),this.gl_.vertexAttribPointer(0,a,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.gl_.blendFunc(this.gl_.ONE,this.gl_.ONE),this.gl_.enableVertexAttribArray(0),this.gl_.vertexAttribPointer(0,a,this.gl_.FLOAT,this.gl_.FALSE,0,0)},RasterProjShaderProgram.prototype.renderTexture=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];this.gl_.bindTexture(this.gl_.TEXTURE_2D,a),this.gl_.uniform2f(this.locDataLambdaPhi1_,c,d),this.gl_.uniform2f(this.locDataLambdaPhi2_,e,f),this.gl_.drawArrays(this.gl_.TRIANGLE_STRIP,0,4)},RasterProjShaderProgram.prototype.renderPolyline=function(a){this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(a)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,a.length/2)},RasterProjShaderProgram.prototype.setPolylineData=function(a){this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(a))},RasterProjShaderProgram.prototype.renderPolylineData=function(a,b){"undefined"!=typeof b&&this.gl_.uniform1f(this.locTranslateY_,b),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,a/2)};var GraticuleGenerator=function(a,b,c){this.projection=a,this.degUnit=c,this.maxNumPoints=b,this.graticulePointsDistLimit=.01,this.maxRecursion=6};GraticuleGenerator.prototype.transform_=function(a,b,c){var d=this.projection.forward(b,c);return d?a.forwardPoint([d.x,d.y]):null},GraticuleGenerator.prototype.isFarAway_=function(a,b,c){if(!a)return!1;var d=Math.abs(a[0]-b[0])+Math.abs(a[1]-b[1]);return c<d},GraticuleGenerator.prototype.checkScreenRect=function(a){return-1<=a[0]&&a[0]<=1&&-1<=a[1]&&a[1]<=1},GraticuleGenerator.prototype.generateLatitudeLineAtLon=function(a,b,c,d){this.generateLatitudeLines_(b,a*Math.PI/180,c,d)},GraticuleGenerator.prototype.generateLongitudeLineAtLat=function(a,b,c,d){this.generateLongitudeLines_(b,a*Math.PI/180,c,d)},GraticuleGenerator.prototype.generateLines=function(a){for(var b=a[0],c=a[1],d=a[2],e=a[3],f=this.projection.inverseBoundingBox(b,c,d,e),g=new CoordTransform(a,[-1,-1,1,1]),h=Math.ceil((180*f.lambda[0]/Math.PI+180)/this.degUnit)*this.degUnit-180,i=Math.ceil((180*f.phi[0]/Math.PI+80)/this.degUnit)*this.degUnit-80,j=new PolylineContainer,k=180*f.lambda[1]/Math.PI,l=h;l<=540&&!(k<l||h+360<=l);l+=this.degUnit)this.generateLatitudeLineAtLon(l,j,f.phi,g);for(var m=180*f.phi[1]/Math.PI,n=i;n<=80&&!(m<n);n+=this.degUnit)this.generateLongitudeLineAtLat(n,j,f.lambda,g);return j.polylineArray},GraticuleGenerator.prototype.generateLatitudeLines_=function(a,b,c,d){var e=this.maxNumPoints-1,f=80*Math.PI/180,g=c[0]<-f?-f:c[0],h=f<c[1]?f:c[1];if(g*h<0){var i=LatitudeLineInterpolator.create(this.projection,d,b,g,0,e),j=LatitudeLineInterpolator.create(this.projection,d,b,0,h,e);this.generateEachLine_(a,d,i),this.generateEachLine_(a,d,j)}else{var k=LatitudeLineInterpolator.create(this.projection,d,b,g,h,e);this.generateEachLine_(a,d,k)}},GraticuleGenerator.prototype.generateLongitudeLines_=function(a,b,c,d){var e=this.maxNumPoints-1;if(Math.PI<c[1]-c[0]){var f=(c[0]+c[1])/2,g=LongitudeLineInterpolator.create(this.projection,d,b,c[0],f,e),h=LongitudeLineInterpolator.create(this.projection,d,b,f,c[1],e);this.generateEachLine_(a,d,g),this.generateEachLine_(a,d,h)}else{var i=LongitudeLineInterpolator.create(this.projection,d,b,c[0],c[1],e);this.generateEachLine_(a,d,i)}},GraticuleGenerator.prototype.generateEachLine_=function(a,b,c){if(!c)return!1;if(this.maxRecursion<c.recurseCount())return this.generateEachPoints_(a,b,c),!0;var d=c.getNormBetweenEndPoints()/c.max();if(d<this.graticulePointsDistLimit)return this.generateEachPoints_(a,b,c),!0;for(var e=c.divide(this.projection,b),f=0;f<e.length;++f)this.generateEachLine_(a,b,e[f]);return!0},GraticuleGenerator.prototype.generateEachPoints_=function(a,b,c){var d=b.scaleY()*Math.PI/10,e=null;this.checkScreenRect(c.iniPoint)?a.add(c.iniPoint):e=c.iniPoint;for(var f=c.iniPoint,g=1;g<c.max();++g){var h=this.transform_(b,c.lambda(g),c.phi(g));h?this.checkScreenRect(h)?(this.isFarAway_(f,h,d)?(a.endPolyline(),a.add(h)):(e&&a.add(e),a.add(h)),e=null):(this.isFarAway_(f,h,d)?a.endPolyline():a.endPolyline(h),e=h):(a.endPolyline(),e=null),f=h}this.isFarAway_(f,c.finPoint,d)?a.endPolyline():a.endPolyline(c.finPoint)};var LongitudeLineInterpolator=function(a,b,c,d,e,f,g){this.iniPoint=e,this.finPoint=f,this.phi_=b,this.lambda1_=c,this.lambda2_=d,this.max_=g,this.length_=d-c,this.recurseCount_=0};LongitudeLineInterpolator.create=function(a,b,c,d,e,f){for(var g,h=e-d,i=null,j=null,k=0;k<f;++k){g=h*k/f+d;var l=a.forward(g,c);if(l){i=b.forwardPoint([l.x,l.y]),j=g;break}}if(!i)return null;for(var m=null,n=null,o=f;k<o;--o){g=h*o/f+d;var p=a.forward(g,c);if(p){m=b.forwardPoint([p.x,p.y]),n=g;break}}return m?new LongitudeLineInterpolator(b,c,j,n,i,m,f):null},LongitudeLineInterpolator.prototype.recurseCount=function(){return this.recurseCount_},LongitudeLineInterpolator.prototype.max=function(){return this.max_},LongitudeLineInterpolator.prototype.getNormBetweenEndPoints=function(){return Math.abs(this.finPoint[0]-this.iniPoint[0])+Math.abs(this.finPoint[1]-this.iniPoint[1])},LongitudeLineInterpolator.prototype.lambda=function(a){return this.length_*a/this.max_+this.lambda1_},LongitudeLineInterpolator.prototype.phi=function(a){return this.phi_},LongitudeLineInterpolator.prototype.divide=function(a,b){var c=[],d=(this.lambda1_+this.lambda2_)/2,e=LongitudeLineInterpolator.create(a,b,this.phi_,this.lambda1_,d,this.max_);e&&(e.recurseCount_=this.recurseCount_+1,c.push(e));var f=LongitudeLineInterpolator.create(a,b,this.phi_,d,this.lambda2_,this.max_);return f&&(f.recurseCount_=this.recurseCount_+1,c.push(f)),c};var LatitudeLineInterpolator=function(a,b,c,d,e,f,g){this.iniPoint=e,this.finPoint=f,this.lambda_=b,this.phi1_=c,this.phi2_=d,this.max_=g,this.length_=d-c,this.recurseCount_=0};LatitudeLineInterpolator.create=function(a,b,c,d,e,f){for(var g,h=e-d,i=null,j=null,k=0;k<f;++k){g=h*k/f+d;var l=a.forward(c,g);if(l){i=b.forwardPoint([l.x,l.y]),j=g;break}}if(!i)return null;for(var m=null,n=null,o=f;k<o;--o){g=h*o/f+d;var p=a.forward(c,g);if(p){m=b.forwardPoint([p.x,p.y]),n=g;break}}return m?new LatitudeLineInterpolator(b,c,j,n,i,m,f):null},LatitudeLineInterpolator.prototype.recurseCount=function(){return this.recurseCount_},LatitudeLineInterpolator.prototype.max=function(){return this.max_},LatitudeLineInterpolator.prototype.getNormBetweenEndPoints=function(){return Math.abs(this.finPoint[0]-this.iniPoint[0])+Math.abs(this.finPoint[1]-this.iniPoint[1])},LatitudeLineInterpolator.prototype.lambda=function(a){return this.lambda_},LatitudeLineInterpolator.prototype.phi=function(a){return this.length_*a/this.max_+this.phi1_},LatitudeLineInterpolator.prototype.divide=function(a,b){var c=[],d=(this.phi1_+this.phi2_)/2,e=LatitudeLineInterpolator.create(a,b,this.lambda_,this.phi1_,d,this.max_);e&&(e.recurseCount_=this.recurseCount_+1,c.push(e));var f=LatitudeLineInterpolator.create(a,b,this.lambda_,d,this.phi2_,this.max_);return f&&(f.recurseCount_=this.recurseCount_+1,c.push(f)),c};var PolylineContainer=function(){this.polylineArray=[],this.currentPoints_=null,this.currentIndex_=0};PolylineContainer.prototype.endPolyline=function(a){if(!this.currentPoints_)return!1;var b=!1;return a&&(this.currentPoints_[this.currentIndex_++]=a[0],this.currentPoints_[this.currentIndex_++]=a[1]),2<this.currentPoints_.length&&(this.polylineArray.push(this.currentPoints_),b=!0),this.currentPoints_=null,this.currentIndex_=0,!0},PolylineContainer.prototype.add=function(a){return!!a&&(this.currentPoints_||(this.currentPoints_=[],this.currentIndex_=0),this.currentPoints_[this.currentIndex_++]=a[0],this.currentPoints_[this.currentIndex_++]=a[1],!0)},"undefined"!=typeof module&&module.exports&&(module.exports=ProjMath);